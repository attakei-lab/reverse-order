"""Common test contexts."""

from pathlib import Path
from subprocess import PIPE, CompletedProcess, run
from typing import Callable, Tuple

import pytest

project_root = Path(__file__).parent.parent


def pytest_sessionstart(session):
    """Generate age binary for testing."""
    print("Now building binary from Cargo ... ", end="")
    proc = run(["cargo", "build"], stdout=PIPE, stderr=PIPE, cwd=project_root)
    if proc.returncode != 0:
        print("Failed!!")
        pytest.exit(1)
    print(" OK!")


@pytest.fixture
def root() -> Path:
    """Path-object of project root."""
    return project_root


@pytest.fixture
def bin_dir(root: Path) -> Path:
    """Full-path of binary generated by ``cargo build``."""
    bin_path = root / "target" / "debug"
    return str(bin_path.resolve())


@pytest.fixture
def cmd(tmp_path: Path) -> Callable[[Tuple[..., str]], CompletedProcess]:
    """Shortcut to run command on subprocess."""

    def _cmd(*args, **kwargs) -> CompletedProcess:
        kwargs.setdefault("cwd", tmp_path)
        return run(
            args,
            stdout=PIPE,
            stderr=PIPE,
            text=True,
            **kwargs,
        )

    return _cmd
